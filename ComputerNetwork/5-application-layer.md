# 第六章 应用层

## 导读

### 【考纲内容】

1.   网络应用模型
     +   客户/服务器模型$P2P$模型
2.   域名系统$DNS$
     +   层次域名空间
     +   域名服务器
     +   域名解析过程
3.   文件传输协议$FTP$
     +   $FTP$的工作原理
     +   控制连接与数据连接
4.   电子邮件$E-mail$
     +   电子邮件系统的组成结构
     +   电子邮件格式与$MIME$
     +    $SMTP$与$POP3$
5.   万维网$WWW$
     +   $WWW$的概念与组成结构
     +   $HTTP$

### 【知识导图】

![ca4b0743a9fc45638c6c826a90cf758a~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031102276.webp)

### 【复习提示】

+   本章内容既可以以选择题的形式考查，也可以结合其他章节的内容出综合题
+   所以牢固掌握本章的几个典型应用层协议是关键
+   我们生活中的很多网络应用都是建立在这些协议的基础上的，因此在学习时要注意联系实际，提高学习的兴趣，才会获得更好的效果。

## 网络应用模型

### 客户/服务器$C/S$模型

客户/服务器$C/S(Client/Server)$模型中服务器提供计算服务的设备，而客户指请求计算服务的主机。

![image-20230803112448368](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031124423.png)

$C/S$模型中，有一个总是打开的主机称为服务器，它服务于许多来自其他称为客户机的主机请求。其工作流程如下

1.   服务器处于接收请求的状态。
2.   客户机发出服务请求，并等待接收结果。
     +   客户程序必须知道服务器程序的地址
         +   客户机上一般不需要特殊的硬件和复杂的操作系统。 
3.   服务器收到请求后，分析请求，进行必要的处理，得到结果并发送给客户机。
     +   服务器程序不需要知道客户程序的地址
         +   服务器上运行的软件则是专门用来提供某种服务的程序，可同时处理多个远程或本地客户的要求
         +   系统启动后即自动调用并一直不断地运行着，被动地等待并接收来自各地客户的请求

服务器的特点：

1. 永久提供服务。
2. 永久访问地址/域名。

客户机的特点：

1. 与服务器通信，使用服务器提供的服务。
2. 间歇接入网络。
3. 可能使用动态$IP$地址。
4. 不能直接与其他客户机通信。

#### $C/S$模型的特点

客户/服务器模型最主要的特征是：客户是服务请求方，服务器是服务提供方。

+   如$Web$应用程序，其中总是打开的$Web$服务器服务于运行在客户机上的浏览器的请求
    +   当$Web$服务器接收到来自客户机对某对象的请求时，它向该客户机发送所请求的对象以做出响应
+   ==常见的使用客户/服务器模型的应用包括$Web$、文件传输协议$FTP$、远程登录和电子邮件等。==

客户/服务器模型的主要特点还有

1.   网络中各计算机的地位不平等
     +   服务器可以通过对用户权限的限制来达到管理客户机的目的，使它们不能随意存储/删除数据，或进行其他受限的网络活动
     +   整个网络的管理工作由少数服务器担当，因此网络的管理非常集中和方便。
2.   客户机相互之间不直接通信
     +   例如，在$Web$应用中两个浏览器并不直接通信。
3.   可扩展性不佳
     +   受服务器硬件和网络带宽的限制，服务器支持的客户机数有限。
4.   服务器性能的好坏决定了整个系统的性能
     +   当大量用户请求服务时，服务器就必然成为系统的瓶颈

### P2P模型

对等模型也可以看作$C/S$模型的变形

$P2P$模型的思想是整个网络中的传输内容不再被保存在中心服务器上，每个结点都同时具有下载、上传的功能，其权利和义务都是大体对等的。

各计算机没有固定的客户和服务器划分。相反，任意一对计算机，称为对等方$Peer$，直接相互通信

实际上，$P2P$模型从本质上来看仍然使用客户/服务器模式，每个结点既作为客户访问其他结点的资源，也作为服务器提供资源给其他结点访问。

当前比较流行的$P2P$应用有$PPlive，Bittorrent$和电驴等

![image-20230803112457107](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031124153.png)

对等模型的特点：

1. 不存在永远在线的服务器。
2. 每个主机既提供服务也可以提供服务。
3. 大大提高了系统效率和资源利用率
    +   减轻了服务器的计算压力，消除了对某个服务器的完全依赖，可以将任务分配到各个结点上
    +   例如，播放流媒体时对服务器的压力过大，而通过$P2P$模型，可以利用大量的客户机来提供服务
4. 任意端系统或结点之间可以直接通信。
    +   多个客户机之间可以直接共享文档
5. 结点间歇接入网络。
6. 结点可能改变$IP$地址。
7. 扩展性好。
    +   传统服务器有响应和带宽的限制，因此只能接受一定数量的请求
8. 网络健壮性强。
    +   单个结点的失效不会影响其他部分的结点
9. 占用较多内存，影响速度。
    +   在获取服务的同时，还要给其他结点提供服务

## DNS

域名系统将域名转换为$IP$地址。域名方便记忆。基于客户/服务器模式，运行在$UDP$上，使用$53$号端口。

域名系统是一个联机分布式的数据库系统，并采用客户/服务器模式。

==从概念上可将$DNS$分为$3$部分：层次域名空间、域名服务器和解析器。==

### 层次域名空间

域名从右到左级别降低，最右边的是顶级域名，如`www.baidu.com`，`com`就是顶级域名，`baidu`就是二级域名，`www`就是三级域名。其实$com$后面应该有一个点，这个点就是根。

关于域名中的标号有以下几点需要注意：

+ 标号中的英文不区分大小写。
+ 标号中除连字符`_`外不能使用其他的标点符号。
+ 每个标号不超过$63$个字符，多标号组成的完整域名最长不超过$255$个字符。
+ 级别最低的域名写在最左边，级别最高的顶级域名写在最右边。

顶级域名$TLD(Top\; Level \;Domain)$分为：

+ 国家顶级域名：$cn$，$us$等。
+ 通用顶级域名：$com$（商业组织），$net$（信息服务提供机构），$org$（非盈利机构），$gov$（政府），$int$（国际组织），$aero$（航空企业），$museum$（博物馆），$travel$（旅游业）等。
+ 基础结构域名/反向域名：$arpa$，用于反向域名解析。

二级域名分为：

+ 类别域名：$ac$（科研机构），$com$（盈利机构），$edu$（教育机构），$net$（信息服务提供机构），$org$（非盈利机构），$gov$（政府），$mil$（国防机构）。
+ 行政区域名：用于省市如$bj$等。
+ 自主注册域名，要求全球唯一。

### 域名服务器

域名到$IP$地址的解析由运行在域名服务器上的程序完成。一个服务器管辖的范围称为区。

+ 根域名服务器：
    + 知道所有顶级域名服务器域名与$IP$地址。
    + 若本地域名服务器不能解析首先交给根域名服务器。
    + 一共$13$个根域名服务器，$A$到$M$。
    + 用来管辖顶级域，不直接进行地址转换，而是告诉本地域名服务器下一步应该找哪个顶级域名服务器进行查询。
+ 顶级域名服务器：管理该顶级域名服务器注册的所有二级域名。
+ 权限（授权）域名服务器：
    + 负责一个区（域）的域名服务器。
    + 每台主机都必须在权限域名服务器上登记。
    + 权限域名服务器也可以是本地域名服务器。
    + 授权域名服务器一定能够将其管辖的主机名转换为该主机的$IP$地址。
+ 本地域名服务器：当一个主机发出$DNS$查询请求时，这个请求报文就发送给本地域名服务器，是最近的服务器。

### 域名解析过程

将域名映射为$IP$地址称为正向解析，把$IP$地址映射为域名称为反向解析。

需要请求时通过本机$DNS$客户端构造一个$DNS$请求报文，以$UDP$数据报方式发送给本地域名服务器。

+ 递归查询：
    + 本地域名服务器查找根域名服务器$\to$根域名服务器查找顶级域名服务器$\to$顶级域名服务器查找权限域名服务器
    + 最后得到的结果再由权限域名服务器$\to$顶级域名服务器$\to$根域名服务器$\to$本地域名服务器$\to$主机。（靠别人）

+ 递归与迭代相结合的查询：本地域名服务器分别查找根域名服务器，顶级域名服务器，权限域名服务器。（靠自己）

![域名解析过程](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031104317.png)

一般使用递归与迭代相结合的查询：

1. 客户机向其本地域名服务器发出**$DNS$请求报文**（递归查询）。
2. 本地域名服务器收到请求后，查询本地缓存
    +   若有则直接得到
    +   若没有该记录，则以$DNS$客户的身份向根域名服务器发出**解析请求报文**（迭代查询）。
3. 根域名服务器收到请求后，判断该域名属于$.com$域，将对应的顶级域名服务器$dns.com$的**$IP$地址返回**给本地域名服务器。
4. 本地域名服务器向顶级域名服务器$dns.com$发出**解析请求报文**（迭代查询）。
5. 顶级域名服务器$dns.com$收到请求后，判断该域名属于$abc.com$域，因此将对应的授权域名服务器$dns.abc.com$的**地址返回**给本地域名服务器。
6. 本地域名服务器向授权域名服务器$dns.abc.com$发起**解析请求报文**（迭代查询)。
7. 授权域名服务器$dns.abc.com$收到请求后，将查询结果**返回**给本地域名服务器
8. 本地域名服务器将查询结果保存到本地缓存，同时**返回**给客户机。

==共使用了$ 8$个$UDP$报文==

为了解决查询速度过慢，高速缓存可以存储域名与$IP$地址值。

因为主机名和$IP$地址之间的映射不是永久的，所以==$DNS$服务器将在一段时间后丢弃高速缓存中的信息。==

## 文件传送协议$FTP$

分为文件传送协议$FTP(File \;Transfer\; Protocol)$和简单文件传送协议$TFTP$。

### FTP协议

默认数据传输端口$20$，控制端口$21$。这些端口都是服务器上的，客户端的端口由程序自己分配。

可以指明文件类型与格式，并可以给予存取权限。

$FTP$提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。

==它屏蔽了各计算机系统的细节，因而适合于在异构网络中的任意计算机之间传送文件==。

+ 提供不同种类主机系统之间的文件传输能力。
    + 硬、软件体系等都可以不同

+ $FTP$基于$C/S$模型
    + 用户通过一个客户机程序连接至远程计算机上运行的服务器程序
    + 依照$FTP$协议提供服务，进行文件传输的计算机就是$FTP$服务器，连接$FTP$服务器，遵循$FTP$协议与服务器传送文件的电脑就是$FTP$服务端。

+ 以用户权限管理的方式提供用户对远程$FTP$服务器上的文件管理能力
+ 可以使用匿名$FTP$的方式提供公用文件共享的能力

#### FTP协议工作原理

$FTP$采用客户/服务器的工作方式，它==使用$TCP$可靠的传输服务==

一个$FTP$服务器进程可同时为多个客户进程提供服务。FTP的服务器进程由两大部分组成

1.   一个主进程，负责接收新的请求
2.   另外有若干从属进程，负责处理单个请求。

FTP服务器必须在整个会话期间保留用户的状态信息。特别是服务器必须把指定的用户账户与控制连接联系起来，服务器必须追踪用户在远程目录树上的当前位置

+ 登录（用户名+密码或匿名登录）。
+ 使用$TCP$协议提供可靠传输。
+ 服务器进程：$1$个主进程与$n$个从属进程提供服务。

为什么有匿名登陆：对于一些公共服务器来说，增加验证阶段就是增加资源开销，减少验证阶段就可以节省资源来更好地服务，使用特殊用户名$anonymous$。

主进程和从属进程的区别：主进程是打开端口，让外部发送的数据可以进来，并且将这些数据逐个分配各从属进程。从属进程则是单独为这些数据服务。

#### FTP协议连接流程

![FTP协议工作原理](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031104785.png)

1.   客户端和服务器端先建立$TCP$连接，端口是熟知端口` 21 `，称为控制连接
     +   用来传输控制信息，以七位$ASCII$格式传输。
     +   控制连接并不用来传送文件
     +   ==控制连接在整个会话期间一直保持打开状态==

2.   等待客户进程发连接请求
     +   确认是主动建立连接还是被动建立连接。
     +   简单概括为，
         +   主动模式传送数据是“服务器”连接到“客户端”的端口
         +   被动模式传送数据是“客户端”连接到“服务器”的端口
3.   服务器端的控制进程在接收到FTP客户发来的文件传输请求后，就创建“**数据传送进程**”和“**数据连接**”。
     +   **数据连接**用来连接客户端和服务器端的数据传送进程
     +   **数据传送进程**实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行
4.   主动连接$PORT$是指服务器端主动发送请求和客户端进行连接，此时服务器端端口号固定是`20`。
     +   工作原理
         +   客户端连接到服务器的`21`端口，登录成功后要读取数据时，客户端随机开放一个端口，并发送命令告知服务器，服务器收到`PORT`命令和端口号后，通过`20`端口和客户端开放的端口连接，发送数据
5.   被动连接$PASV$是指客户端发送请求和服务器端建立数据传送连接，此时服务器端端口号不确定，由两者协商得到，一般大于`1024`。
     +   $PASV$模式的不同点是，客户端要读取数据时，发送`PASV`命令到服务器，服务器在本地随机开放一个端口，并告知客户端，客户端再连接到服务器开放的端口进行数据传输
6.   数据传输完成之后，数据连接断开，控制连接继续保持，直至两边发送断开请求。

数据连接与控制连接都属于从属进行，控制连接始终保持，数据连接只保持一会。

正是因为$FTP$的控制信息是单独使用一个端口，所以称$FTP$的控制信息是带外传送$Out-of-band$的。

#### FTP协议传输模式

+ 文本模式：$ASCII$模式，以文本序列传输数据。
+ 二进制模式：$Binary$模式，以二进制序列传输数据。

### TFTP协议

$TFTP$协议了解即可。

#### 特点

+ 简单文件传送协议端口号为$69$。
+ 每次传输的数据报文中包含$512$字节，最后一次可不足$512$字节。
+ 数据报按序编号，从$1$开始。
+ 支持$ASCII$码或二进制传输。
+ 可对文件进行读写。
+ 首部简单。
+ 使用$C/S$模型。
+ 使用$UDP$数据报。

#### 优点

+ 适用于只支持$UDP$协议的环境，可以同时向许多机器下载。
+ 占用的内存很小且很容易实现，对于小型计算机或特殊设备非常有利。

#### 缺点

+ 需要自己实现差错改正。
+ 只支持文件传输而不支持交互。
+ 没有很大的命令集，无法列目录，也无法用户身份鉴定。

#### TFTP协议工作流程

+ 客户进程发送一个读/写请求报文给$TFTP$服务器进程，端口号为$69$。
+ $TFTP$服务器选择另一个端口和客户进程通信。
+ 传输文件长度若正好是$512$的整数倍，则传输完毕后还要发送一个只含有首部而无数据的报文。
+ 传输文件长度若不是$512$的整数倍，则最后一个报文数据部分不满$512$字节，正好作为文件结束标志。

## TELNET协议

远程终端协议（终端仿真协议）让用户使用$TCP$连接登录到远地主机。其定义了数据和命令应该如何通过互联网，即网络虚拟终端$NVT$。

现在这个协议很少使用了。

## 万维网

### WWW

+ 万维网$WWW(World\;Wide\;Web)$是一个分布式、联机式的信息存储空间，是无数个网络结点与网页的集合。
    + 在这个空间中： 一样有用的事物称为一样“资源”，并由一个全域**统一资源定位符**$URL$标识
    + 这些资源通过**超文本传输协议**$HTTP$传送给使用者，而后者通过单击链接来获取资源
    + **超文本标记语言**$HTML$​使得万维网页面的设计者可以很方便地用一个超链接从本页面的某处链接到因特网上的任何一个万维网页面，并能够在自己的计算机屏幕上显示这些页面。

+ 是以$C/S$方式工作
    + 浏览器是在用户主机上的万维网客户程序
    + 而万维网文档所驻留的主机则运行服务器程序，这台主机称为万维网服务器

+ 万维网的内核部分是由三个标准构成的
    1.   **统一资源定位符**$URL$
         +   负责标识万维网上的各种文档，并使每个文档在整个万维网的范围内具有唯一的标识符$URL$
    2.   **超文本传输协议**$HTTP$
         +   一个==应用层协议==
         +   ==它使用$TCP$连接进行可靠的传输==
         +   $HTTP$是万维网客户程序和服务器程序之间交互所必须严格遵守的协议。
    3.   **超文本标记语言**$HTML(（HyperText\; Markup\; Language)$
         +   一种文档结构的标记语言，它使用一些约定的标记对页面上的各种信息（包括文字、声音、图像、视频等）、格式进行描述
+ 客户程序向服务器程序发出请求， 服务器程序向客户程序送回客户所要的万维网文档。工作流程如下：
    1.   Web用户使用浏览器（指定URL）与Web服务器建立连接，并发送浏览请求。
    2.   Web服务器把URL转换为文件路径，并返回信息给Web浏览器。
    3.   通信完成，关闭连接

### URL

统一资源定位符唯一标识资源，一般形式是：
$$
Protocol://Host:Port/Path
$$

+   协议$Protocol$指用什么协议来获取万维网文档，常见的协议有$http$、$ftp$等

+   主机$Host$是存放资源的主机在因特网中的域名或IP地址
+   端口$Port$和路径$Path$有时可省略。

$URL$不区分大小写。

$URL$可以使用$HTTP$也可以使用$FTP$。

### HTTP协议

+ 超文本传输协议定义了浏览器即**万维网客户进程**怎样向万维网服务器请求文档，以及服务器如何传输文档。
+ 服务器监听$TCP$运行于`80`端口。
    + 当监听到连接请求后便与浏览器建立$TCP$连接

+ 从层次的角度看，$HTTP$是面向事务的$Transaction-oriented$应用层协议
    + 它规定了在浏览器和服务器之间的请求和响应的格式与规则
    + 是万维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础。

+ $HTTP$可以不一次性下载完页面的所有资源，可以只下载文本部分，其他音频视频等待用户下一步请求之后再传输。

#### HTTP协议工作流程

![image-20230803220031793](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308032200963.png)

1. 浏览器分析$URL$。
2. 浏览器向$DNS$请求解析$IP$地址。
3. $DNS$解析出$IP$地址。
4. 浏览器与服务器建立$TCP$连接。
5. 浏览器发出取文件命令。
6. 服务器响应。
7. 浏览器显示。
8. 释放$TCP$连接。

#### HTTP协议的特点

1. 无状态（即无法记忆用户），如果需要记忆就需要使用$Cookie$，是存储在用户主机的文本协议。
    +   $HTTP$的无状态特性简化了服务器的设计，使服务器更容易支持大量并发的$HTTP$请求
2. $HTTP$协议采用$TCP$连接，但是==$HTTP$协议本身无连接==，即交换$HTTP$报文之前不需要先建立$HTTP$连接。

#### HTTP协议的连接

$HTTP$连接包括：持久连接和非持久连接

##### 非持久连接$Close$。

+ 每个网页元素对象的传输都需要单独建立一个$TCP$连接
+ ==`HTTP 1.0`只支持非持久连接==
+ 如下图为非持久连接求一个万维网文档所需的时间
    + 请求一个万维网文档所需的时间是该文档的传输时间加上两倍往返时间$RTT$
        + 传输时间与文档大小成正比
        + 两倍往返时间$RTT$为一个$RTT$用于$TCP$连接，另一个$RTT$用于请求和接收文档

    + 每个对象引用都导致$2\times RTT$的开销，
    + 此外每次建立新的TCP连接都要分配缓存和变量，使万维网服务器的负担很重。 


![HTTP非持久连接](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031104914.png)

##### 持久连接$Keep-alive$

所谓持久连接，是指万维网服务器在发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的HTTP请求和响应报文

分为非流水线和流水线两种方式。

+   对于非流水线方式，客户在收到前一个响应后才能发出下一个请求，服务器发送完一个对象后，其$TCP$连接就处于空闲状态，浪费了服务器资源

    +   如下图为使用非流水线持久连接

    ![HTTP持久连接](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031104288.png)

+   对于流水线方式，客户每遇到一个对象引用就立即发出一个请求，因而客户可以逐个地连续发出对各个引用对象的请求

    +   $HTTP/1.1$的默认方式是使用流水线的持久连接
    +   如果所有的请求和响应都是连续发送的，那么所有引用的对象共计经历1个$RTT$延迟，而不是像非流水线方式那样，每个引用都必须有$1$个$RTT$延迟。
    +   这种方式减少了 TCP连接中的空闲时间,提高了效率

#### HTTP协议报文

$HTTP$报文分为请求报文和响应报文，因为其面向文本$Text-Oriented$，所以报文中的每一个字段都是$ASCII$码串。

![image-20230803220326089](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308032203189.png)

HTTP请求报文和响应报文都由三个部分组成。从图6.14可以看出，这两种报文格式的区别就是开始行不同

+ 请求报文与响应报文的第一行叫做开始行，用于互相区分是请求报文还是响应报文。
  
    + 在请求报文中的开始行称为请求行，而在响应报文中的开始行称为状态行
    + 开始行的三个字段之间都以空格分隔，最后的`CR`和`LF`分别代表`回车`和`换行`。
    + 请求报文中的`方法`字段是指命令，就是对所请求的对象进行什么操作，如获取/删除等等。
    
        ![image-20230803222313833](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308032223905.png)
    
        -   **GET**：GET方法请求指定资源的表示形式。使用GET的请求应仅检索数据。
        -   **HEAD**：HEAD方法要求与GET请求相同的响应，==但没有响应正文==。
        -   **POST**：POST方法将实体提交到指定资源，通常会导致服务器上状态或副作用的更改。
        -   **PUT**：PUT方法用请求有效负载替换目标资源的所有当前表示形式。
        -   **DELETE**：DELETE方法删除指定的资源。
        -   **CONNECT**：CONNECT方法建立到目标资源所标识服务器的隧道。
        -   **OPTIONS**：OPTIONS方法描述目标资源的通信选项。
        -   **TRACE**：TRACE方法沿着目标资源路径执行消息环回测试。
        -   **PATCH**：PATCH方法对资源进行部分修改1。
    + $URL$就是资源标识符。
    + `状态码`，表明服务器当前的状态:
    
        + $1xx$表示通知信息的，如请求收到了或正在处理。
        + $2xx$表示成功，如接受或知道了。
        + $3xx$表示重定向，如要完成请求还必须采取进一步的行动。
        + $4xx$表示客户的差错，如请求中有错误的语法或不能完成。
        + $5xx$表示服务器的差错，如服务器失效无法完成请求。
    + `版本`是指使用的是什么版本的$HTTP$协议。
    + $CRLF$标识一行的结束，分别为回车和换行。同时，在整个首部行结束时，为了区别首部行和实体主体还会有一行单独的$CRLF$。
    
+ 首部行用于说明浏览器、服务器和报文主体的一些信息。

    + 首部可以有几行，但也可以不使用
    + 在每个首部行中都有首部字段名和它的值，每一行在结束的地方都需要`回车`和`换行`
    + 整个首部行结束时，还有一个`换行`空行将首部行和后面的实体主体分开

+ 实体柱体：请求报文一般不用，响应报文也可能没有。

## 电子邮件

电子邮件就在因特网上流行起来。电子邮件是一种异步通信方式，通信时不需要双方同时在场。

电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可以随时上网到自己使用的邮件服务器进行读取

### 电子邮件格式

一个电子邮件分为信封和内容两大部分，邮件内容又分为首部和主体两部分。

$RFC 822$规定了邮件的首部格式，而邮件的主体部分则让用户自由撰写。用户写好首部后，邮件系统自动地将信封所需的信息提取出来并写在信封上，用户不需要亲自填写信封上的信息。

+ 信封：收件人的邮箱（是必须的，关键词$To:$）等。
+ 内容：
    + 首部：发送人的邮箱；主题（可选，关键词$Subject:$）等。
    + 主体：邮件内容。

电子邮件地址：收件人邮箱名@邮箱所在主机的域名。如$didnelpsun@gmail.com$。

### 电子邮件系统组成结构

应该包括三个部分：用户代理、邮件服务器、电子邮件协议。

![image-20230803225145291](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308032251429.png)

用户代理$UA$：

+   $UA$为用户与电子邮件系统的接口，用户代理向用户提供一个很友好的接口来发送和接收邮件

+   用户代理至少应当具有撰写、显示和邮件处理的功能

    + 撰写就是给用户编辑信件的环境。

    + 显示就是可以看到自己写的和自己收的信件内容。

    + 处理就是对信件进行操作，包括删除，打印，转发等等。

    + 通信就是可以将邮件发送到邮件服务器当中，同时可以从邮件服务器当中读取邮件。


邮件服务器：

+   功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况

    + 邮件服务器端的发送和接受是指从自己的用户代理处接收邮件，之后向对面的邮件服务器发送邮件。

    + 邮件服务器的报告邮件发送结果就是投递是否成功这种情况。

+   邮件服务器既可以作为客户端又可以作为服务器端，使用的是$C/S$方式。

    +   例如，当邮件服务器$A$向邮件服务器$B$发送邮件时，$A$就作为$SMTP$客户，而B是$SMTP$服务器;
    +   反之，当$B$向$A$发送邮件时，B就是$SMTP$客户，而$A$就是$SMTP$服务器

电子邮件协议：

+   邮件发送协议用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件

    + 如$SMTP$。

        + $SMTP$用的是推$Push$的通信方式，即用户代理向邮件服务器发送邮件及在邮件服务器之间发送邮件时，$SMTP$客户将邮件$Push$到$SMTP$服务器。

        >   可以类比`git push` ，下同
        >
        >   ~~看到的这篇笔记的应该都会git吧~~


+   邮件读取协议用于用户代理从邮件服务器读取邮件
    + 收邮件的是$POP3$或者$IMAP$。
        + $POP3$用的是拉$Pull$的通信方式，即用户读取邮件时，用户代理向邮件服务器发出请求，$Pull$用户邮箱中的邮件

### SMTP协议

简单邮件传送协议规定了两个互相通信的$SMTP$进程之间应该如何交换信息。

建立在$TCP$连接上，使用的端口号为$25$。

使用$C/S$模型，负责发送邮件的$SMTP$进程就是$SMTP$客户，负责接收邮件的进程就是$SMTP$服务器。

这里$SMTP$客户和服务器不是固定死的，可以也可以成为服务器，服务器也可以成为用户，由发送方和接收方决定，发送方就是客户，接收方就是服务器。

只支持传输$7$比特$ASCII$码内容，不支持二进制文本。

#### 简单邮件传输协议SMTP

$SMTP(Simple\; Mail\; Transfer\; Protocol)$规定了$14$条命令（几个字母）和$21$种应答信息（三位数字代码+简单文字说明）。具体的过程了解就可以。

由于$SMTP$使用$B/S$方式，因此负责发送邮件的$SMTP$进程就是$SMTP$客户，而负责接收邮件的$SMTP$进程就是$SMTP$服务器。

==$SMTP$使用$TCP$连接，端口号为`25`==

令发送方邮件服务器为$A$，接收方邮件服务器为$B$。

1. 连接建立：
    1. 发送方将邮件发送给$A$（客户）的邮件缓存中。
    2. 每隔一段时间$A$就会扫描缓存，如果有邮件就准备使用$SMTP$协议与$25$号发送，与$B$建立$TCP$连接。
    3. $B$发出应答信息：$220\,Service\,ready$，表明可以发送。
    4. 然后$A$向$B$发送一个$HELLO$命令并附上发送方的主机名。
    5. 如果$B$有能力接收邮件，就应答：$250\,OK$。否则就应答：$421\,Service\,not\,available$。
2. 邮件发送：
    1. $A$会向$B$发送一个命令：$MAIL\,FORM:$<邮件发送者地址>。
    2. 如果$B$能接收，就返回：$250\,OK$，如果不能接收，就返回不能返回的原因的数字代码和英文说明。
    3. $A$收到允许发送的命令后，会发送多个$RCPT$命令：$RCPT\,TO:$<邮件接收者地址>，表示发送给谁。
    4. 如果$B$接收到并确认，就返回：$250\,OK$，如果$B$不能接收，就返回：$550\,No\,such\,user\,here$。
    5. $A$发送$B$一个$DATA$命令，表示要开始传输数据了。
    6. $B$返回：$354\,start\,mail\,input;end\,with$<$CR$><$LF$>.<$CR$><$LF$>。表示$B$同意传输。
    7. $A$开始传输数据。
    8. $A$发送命令：<$CR$><$LF$>.<$CR$><$LF$>表示数据传输已经结束。
    9. $B$返回：$250\,OK$表示明白传输已经结束。
3. 连接释放：
    1. 邮件发完，$A$发送$QUIT$命令表示要释放连接。
    2. $B$返回：$221$表示同意释放$TCP$连接。

### 多用途网际邮件扩充MIME

$SMTP$的缺点：

1. 不能传送可执行文件或其他二进制对象。
2. 仅限于传送$7$位$ASCII$码，不能传送其他非英语国家的文字。
3. $SMTP$服务器会拒绝超过一定长度的邮件。

通用因特网邮件扩充协议$MIME(Multipurpose\; Internet\; Mail\;Extensions)$改善$SMTP$发送数据的缺点，是$SMTP$的功能性扩展。

$MIME$并未改动$SMTP$或取代它。$MIME$的意图是继续使用目前的格式，但增加了邮件主体的结构，并定义了传送非$ASCII$码的编码规则。也就是说，==MIME邮件可在现有的电子邮件程序和协议下传送==

![MIME协议](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202308031105099.png)

$MIME$协议已经逐渐开始应用到浏览器当中，通过对不同文件类型用不同的标识符标识，来让浏览器读取通过$MIME$的相关文件。

### 邮局协议POP

邮局协议$POP(Post \;Office\; Protocol)$现在一般是$POP3$。建立于$TCP$连接上，端口号是$110$，使用$C/S$模型。

工作方式：

+ 下载并保存在服务器。
    + 用户从邮件服务器上读取邮件后，邮件依然会保存在邮件服务器上，用户可再次从服务器上读取该邮件

+ 下载并删除。
    + 邮件一旦被读取，就被从邮件服务器上删除，用户不能再次从服务器上读取

==使用明文在传输层上传输密码，不进行加密。==

与$SMTP$协议一样基于$ASCII$码，只能传输$ASCII$码，如果要传输非$ASCII$码则必须使用$MIME$。

同一个账户可以有多个邮件接收目录。

### IMAP协议

因特网信息访问协议$IMAP(Internet \;Message\; Access\; Protocol)$比$POP$协议更复杂。

提供创建文件夹，移动邮件、查询邮件等连接命令，从而维护了会话用户的状态信息。

当客户端打开$IMAP$服务器邮箱时，用户可以看到邮件的首部，只有打开某个邮件时才上传到用户本地计算机上。所以==适用于低带宽的情况，避免取回不想取回的大数据。==

可以在不同地方不同的计算机上随时处理邮件，还可以只读取邮件的一部分。

### 万维网邮件

此外，随着万维网的流行，目前出现了很多基于万维网的电子邮件，如$Hotmail$、$Gmail$等。这种电子邮件的特点是，用户浏览器与$Hotmail$或$Gmail$的邮件服务器之间的邮件发送或接收使用的是$HTTP$，而仅在不同邮件服务器之间传送邮件时才使用$SMTP$。

## DHCP协议

动态主机配置协议用于动态分配$IP$地址、子网掩码与默认网关等，使用客户/服务器方式，客户端与服务端通过广播方式进行交互，基于$UDP$协议（因为没有$IP$地址所以无法建立连接）。

提供即插即用机制，允许地址重用、移动用户加入网络、在用地址续租。

工作流程：

1. 主机广播“$DHCP$发现报文”，寻找网络中的$DHCP$服务器，从其中获得一个$IP$地址。
2. $DHCP$服务器收到“$DHCP$发现报文”后，广播“$DHCP$提供报文”，其中包括提供$DHCP$客户机的$IP$地址与配置信息。
3. $DHCP$客户机收到“$DHCP$提供报文”，接收$DHCP$服务器所提供的相关参数，客户机广播“$DHCP$请求报文”，向$DHCP$服务器请求提供$IP$地址。
4. $DHCP$服务器广播“$DHCP$确认报文”，将$IP$地址分配给$DHCP$客户机。
