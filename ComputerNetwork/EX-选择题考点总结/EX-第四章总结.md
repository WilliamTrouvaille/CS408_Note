# EX-第四章总结

## 导读

### 【考纲内容】

1.   网络层的功能：异构网络互连、路由与转发、$SDN$基本概念、拥塞控制
2.   路由算法：静态路由与动态路由、距离$-$向量路由算法、链路状态路由算法、层次路由
3.   $IPv4$：$IPv4$分组、$IPv4$地址与$NAT$、子网划分与子网掩码、$CIDR$、路由聚合、$ARP$、$DHCP$与$ ICMP$
4.   $IPv6$：$IPv6$的主要特点、$IPv6$地址
5.   路由协议：自治系统、域内路由与域间路由、$RIP$路由协议、$OSPF$路由协议、$BGP$路由协议
6.   $IP$组播：组播的概念、$IP$组播地址
7.   移动$IP$：移动$IP$的概念、移动$IP$通信过程
8.   网络层设备：路由器的组成和功能、路由表与路由转发

### 【复习提示】

+   本章是历年考查的**重中之重**，尤其是结合第$3$章、第$5$章、第$6$章出综合题的概率很大
+   其中$IPv4$以及路由的相关知识点是核心，历年真题都有涉及，因此必须牢固掌握其原理，也要多做题，以便灵活应用
+   本章的其他知识点，如$IP$组播、移动$IP$、$IPv6$也要有所了解。

## 选择题考点总结

### 网络层基本概念

1.   网络层只向上提供简单灵活的、无连接的、尽最大努力交付的数据报服务。主要任务是将**分组**从源端发送到目的端，为分组交换网上的不同主机提供通信服务。在任意结点间进行数据报传输，但**不可靠**。
2.   网络层功能：网络层的主要任务是实现**网络互联**，进而实现数据包在各网络之间的传输
     1.   异构网络互连：异构网络即传输介质、数据编码方式、链路控制协议及不同的数据单元格式和转发机制，即物理层与数据链路层均不同的网络。网络层需要解决他们之间相连的问题。
     2.   路由选择与分组转发：网络层的主要任务
     3.   软件定义网络$SDN$：可以将网络层抽象地划分为数据层面（也称转发层面）和控制层面
          +   主要执行上述路由选择与分组转发的任务
     4.   拥塞控制：确保子网能够承载所达到的流量

#### 异构网络互连

1.   网络互连是指将两个以上的计算机网络，通过一定的方法，用一些中间设备（又称中继系统）相互连接起来，以构成更大的网络系统。根据所在的层次，中继系统分为以下4种：
     1.   物理层中继系统：转发器，集线器。
     2.   数据链路层中继系统：网桥，交换机
     3.   网络层中继系统：路由器。
     4.   网络层以上的中继系统：网关
2.   网络互连通常是指用路由器进行网络互连和路由选择
     + 使用物理层或数据链路层的中继系统时，只是把一个网络扩大了，而从网络层的角度看，它仍然是同一个网络，一般并不称为网络互连。

3.   路由器要求物理层、数据链路层、网络层协议可以不同，但网络层以上的高层协议必须相同。
     + 由于路由器无法处理上层数据所以要求上层的协议必须相同。

4.   $IP$网络：使用IP协议的虚拟互连网络可简称为IP网络
     + 虚拟互连网络也就是逻辑互连网络，其意思是互连起来的各种物理网络的异构性本来是客观存在的，但是通过IP协议就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。
     + 使用IP网络的好处是，当IP网上的主机进行通信时，就好像在一个单个网络上通信一样， 而看不见互连的各网络的具体异构细节
         + 如具体的编址方案、路由选择协议等

#### 路由选择与分组转发

1.   路由选择即**选择最佳路径**。
     +   “最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。
         +   一般情况下，最佳默认最短
     +   一般指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
2.   分组转发即当一个分组到达时所采取的动作
     1.   指路由器根据转发表将用户的$IP$数据报从合适的端口转发出去。
     2.   分组传输时，源主机和中间路由器都不知道$IP$分组到达目的主机需要经过的完整路径。
     3.   路由器的路由表中包含目的网络和到达该目的网络路径上的下一个路由器的$IP$地址。

#### 软件定义网络$SDN$

1.   $SDN$的两个层次：可以将网络层抽象地划分为数据层面（也称转发层面）和控制层面。在传统互联网中，每个路由器既有转发表又有路由选择软件，即既有数据层面又有控制层面。
     1.   控制平面：用于控制和管理网络协议的运行，即**路由选择**。更贴近应用，所以在上面，即**对应北向接口**。
          1.   **控制平面**负责执行$SDN$控制器的逻辑功能，包括网络拓扑发现、路径计算、流表下发等
     2.   数据平面：主要功能是根据转发表进行转发，即**分组转发**。更贴近交换机，所以在下面，即**对应南向接口**。
2.   $SDN$控制器的三个层次
     1.   对于网络控制应用程序的接口：$SDN$控制器通过**北向接口/北向$API$**与网络控制应用序交互。该$API$允许网络控制应用程序在状态管理层之间读写网络状态。
          +   北向接口是$SDN$控制器向上提供的接口，用于与上层应用程序或网络服务进行交互，这些应用程序可以是网络管理应用、安全应用、负载均衡应用、流量监测应用等
          +   北向接口为上层应用程序提供了一系列的编程接口，使得应用程序能够与$SDN$控制器交互，控制和管理网络资源。
     2.   网络范围状态管理层：由$SDN$**控制平面**作出的最终控制决定，将要求$SDN$控制器具有有关网络的主机链路等最新状态信息。
          +   网络状态数据库用于存储网络拓扑、设备配置信息和流表信息等，以便控制平面进行网络资源管理和控制。
     3.   通信层：$SDN$控制器与受控网络设备之间的通信（$OpenFlow$协议等），包含**南向接口/南向$API$**
          +   南向接口是$SDN$控制器向下提供的接口，用于与网络设备（例如交换机、路由器）进行通信和控制，这些设备支持$OpenFlow$协议或其他$SDN$兼容的协议，通过南向接口与$SDN$控制器进行交互。
          +   $SDN$控制器使用**南向接口**来下发控制指令、获取网络状态信息，并对网络设备进行配置和管理。
3.   $SDN$特点
     1.   不需要路由选择软件，所以不需要路由器之间交换路由信息，而是由网络的控制层面的一个逻辑上的远程控制器进行控制
          +   其掌握主机和网络状态，分析最佳路由，通过$Openflow$协议等将转发表（流表）下发给路由器
          +   路由器只需要收到分组、查找转发表、转发分组。
     2.   特点：控制和转发功能分离。控制层面集中化。接口开放可编程。
     3.   优点：中央集权的优点

          + 全局集中式控制和分布式高速转发，既利于控制层面的全局优化，又利于高性能的网络转发。
          + 灵活可编程与性能的平衡，控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置。
          + 降低成本，控制和数据层面分离后，尤其是在使用开放的接口协议后，就实现了网络设备的制造与功能软件的开发相分离，从而有效降低了成本。
     4.   缺点：中央集权的危害

          + 安全风险，集中管理容易受攻击，如果崩溃，整个网络会受到影响。
          + 瓶颈问题，原本分布式的控制层面集中化后，随着网络规模扩大，控制器可能成为网络性能的瓶颈。

#### 拥塞控制

1.   拥塞定义：在通信子网中，因出现过量的分组而引起网络性能下降的现象称为拥塞
2.   拥塞分类
     + 如果网络负载增加，网络吞吐量**明显小于正常吞吐量**，则进入**轻度拥塞**。
     + 如果网络负载增加，网络吞吐量**反而下降**，则进入**拥塞**。
     + 如果网络负载增加，网络吞吐量**变为零**，则进入**死锁**。
3.   拥塞避免：为避免拥塞现象的出现，要采用能防止拥塞的一系列方法对子网进行拥塞控制
     + 拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免由于拥塞而出现分组的丢失，以及严重拥塞而产生网络死锁的现象

4.   拥塞控制：拥塞控制的作用是确保子网能够承载所达到的流量。这是一个全局性的过程，涉及各方面的行为：主机、路由器及路由器内部的转发处理过程等。**单一地增加资源并不能解决拥塞**。拥塞控制的方法有两种：
     1.   开环控制：在拥塞之前就提前设计解决。
          +   这是一种静态的预防方法。一旦整个萦统启动并运行，中途就不再需要修改。
          +   开环控制手段包括确定何时可接收新流量、何时可丢弃分组及丢弃哪些分组，确定何种调度策略等
          +   所有这些手段的共性是，在做决定时不考虑当前网络的状态。
     2.   闭环控制：在拥塞时自动调整解决问题。
          +   事先不考虑有关发生拥塞的各种因素，采用监测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方,以便调整网络系统的运行，并解决出现的问题
          +   闭环控制是基于反馈环路的概念，是一种动态的方法。
5.   流量控制和拥塞控制的区别：
     1.   流量控制往往是指在发送端和接收端之间的**点对点**通信量的控制，流量控制所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收
     2.   而拥塞控制必须确保通信子网能够传送待传送的数据，是一个**全局性**的问题，涉及网络中所有的主机、路由器及导致网络传输能力下降的所有因素。 

### 路由算法与协议

1.   路由算法：路由器分组是通过路由表来转发，而路由表由路由算法给出。路由算法就是让路由知道收到报文之后下一步怎么走。

     1.   静态路由算法（非自适应路由算法）：管理员手工配置路由信息。
          + 简便、可靠，在负荷稳定，拓扑变化不大的网络中较好。适用于高度安全的军事网络与较小的商业网络。
          + 路由更新慢，不适合用于大型网络。
     2.   动态路由算法（自适应路由算法）：路由器之间交换信息，按照路由算法优化出路由表。
          + 路由更新快，适用大型网络，及时响应链路反应与网络拓扑变化。
          + 算法复杂，加重网络负担。

     对于动态路由算法，又可以分为

     +   分散性：距离-向量路由算法$\sim RIP$：路由器只掌握物理相连的邻居及链路费用
     +   全局性：链路状态路由算法$\sim OSPF$：所有路由器掌握完整的网络拓扑和链路费用信息。

2.   自治系统$AS$是单一技术管理下的一组路由器。一个$AS$内部使用内部网关协议$IGP$，$AS$之间外部网关协议$EGP$。

     +   一个自治系统内的所有网络都由一个行政单位管辖，一个自治系统的所有路由器在本自治系统内都必须是连通的。

3.   ※※三种协议总结：

     1.   $RIP$是一种分布式的基于距离向量的路由选择协议，它通过**广播$UDP$**报文来交换路由信息。
     2.   $OSPF$是一个内部网关协议，要交换的信息量较大，应使报文的长度尽量短，所以**不使用传输层协议**（如$UDP$或$TCP$），而**直接采用$IP$**。
     3.   $BGP$是一个外部网关协议，在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠传输，所以**采用$TCP$**。

#### 路由信息协议$RIP$

路由信息协议$RIP$（$Routing\; Information\; Protocol$）是一种内部网关协议$IGP$，是一种分布式的基于**距离-向量路由算法**的路由选择协议，最大的优点是简单。

1.   路由选择表：在距离-向量路由算法中，所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点。要求网络中的每一个路由器都维护从它到其他每一个目的网络的唯一最佳路径（即一组距离）。这种路由选择表包含：
     1.   目的网络。
     2.   下一跳路由器。
     3.   路径的代价（也称距离），通常指跳数，即从源端口到目的端口所经过的路由器个数，经过一个路由器跳数$+1$，与路由器直接连接的网络距离为$1$。**$RIP$允许一条路最多只能包含$15$个路由器**，所以**$16$表示网络不可达**。
2.   $RIP$协议交换信息
     1.   仅和相邻路由器交换信息。
     2.   路由器交换的信息是自己的路由表，其中包括每条路径的目的地与路径代价两条信息。
     3.   每$30s$就交换一次，如果$180s$没收到相邻路由器的通告就默认这个路由器出现错误，并更新路由表。
     4.   最开始路由器只知道直接相连的网络，若干次更新后所有路由器都会知道到达本自治系统中任何网络的信息，即收敛。
3.   距离向量算法
     1.   修改相邻路由器发来的$RIP$报文中的所有表项：对地址为$X$的相邻路由器发来的$RIP$报文，修改此报文的所有项目：把下一跳字段中的地址改为$X$，并把所有的距离$+1$。
     2.   对修改后的$RIP$报文中的每一个项目都进行以下步骤：
          1. 本路由器路由表中没有该网络，则把这个项目直接填入路由表中。
          2. 本路由器路由表中已经有该网络，则查看下一跳路由器地址。
              +   如果下一跳的路由器名相同，则表明距离更新了，用收到的项目替换原有项目。
              +   如果下一跳的路由器名不同，原来距离更远则更新。
          3. 否则不处理。
     3.   若$180s$超时，则把该路由器设为不可达，距离设为$16$。
4.   $RIP$协议存在问题：主要是**慢收敛**
     1.   限制了网络规模。
     2.   路由器交换完整的路由表，所以网络规模越大，开销越大。
     3.   当网络出现故障时，要经过较长的时间才能将此信息传送到所有的路由器，即出现**路由回路**问题，称为**慢收敛**
          + 也叫做好消息传得快，坏消息传得慢。
          + 慢收敛是导致发生**路由回路**的根本原因
5.   解决慢收敛方法：
     1.   限制路径最大距离：超过$16$次就认为不可达不再传输。
     2.   分割水平线：路由器从某个接口接收到的更新信息不允许再从这个接口发回去。
     3.   抑制计时器法：等待足够多的时间（一般$60$秒），已确保所有的机器都收到坏消息，而不会错误的连接过时的报文
          + 需要指出的是，**参与$RIP$的机器都要遵循抑制策略，否则任依旧会发生环路**。
          + 缺点是：如果发生环路，在抑制期内这些路由环路任然会维持下去。

     4.   毒性逆转：路由中毒是指在路由信息在路由表中失效时，先**将度量值变为无穷大的数**，而不是马上从路由表中删掉这条路由信息，然后**再将其中毒的路由信息发布出去**，这样相邻的路由器收到该中毒路由就可以通过其度量值就得知这条路由的度量值是$16$，**说明该路由是无效的**。
          + 然后收到中毒路由信息的相邻的路由器会发送一个毒性逆转的信息，表示已经收到中毒路由信息。

     5.   触发刷新：正常情况下，路由器会基于计时器每$30s$将路由表发送给邻居路由器，而触发更新就是立刻发送路由更新信息
          + 也就是说**检测到网络故障的路由器会直接发送一个更新信息给邻居路由器，并依次产生触发更新通知它们的邻居路由器**，此过程就叫触发更新
          + 触发更新这种方式使整个网络上的路由器在最短的时间内收到更新信息。
6.   注意小点
     1.   $RIP$协议只适用于小型互联网。
     2.   $RIP$协议是应用层协议，使用$UDP$传送数据。
     3.   一个$RIP$报文最多只包含$25$个路由，如果超过必须再用多的$RIP$报文传送。

#### 开放最短路径优先协议$OSPF$

开放最短路径优先协议$OSPF$（$Open \;Shortest \;Path\; First$）是一种内部网关协议$IGP$，是基于**链路状态路由算法**的路由选择协议。

1.   $OSPF$协议交换信息

     1.   使用**洪泛法**向自治系统内所有路由器发送信息：即路由器通过输出端口**向所有相邻的路由器发送信息**，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器，但**不再发送给刚刚发来信息的那个路由器**，最终整个区域内所有路由器都得到了这个信息的一个副本。
     2.   发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息，即本路由器和哪些路由器相邻，以及该链路的度量/代价（费用、距离、时延、带宽）等
     3.   路由器根据全网拓扑结构图使用$Dijkstra$最短路径算法计算自己到各目的网络的最优路径，构建新的路由表。但是只存储下一跳，因为只有到了下一跳才知道下一跳怎么走
     4.   只有当链路状态发生变化时，路由器才向所有路由器洪泛发送此信息。
     5.   最后，所有路由器都能建立一个链路状态数据库，即全网拓扑图。

2.   $OSPF$的五种分组类型

     1.   问候分组，用来发现和维持邻站的可达性。
     2.   数据库描述分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
     3.   链路状态请求分组，向对方请求发送某些链路状态项目的详细信息。
     4.   链路状态更新分组，用洪泛法对全网更新链路状态。
     5.   链路状态确认分组，对链路更新分组的确认。 

3.   链路状态路由算法，涉及到$OSPF$的五种分组类型：

     1. 每个路由器发现它的邻居结点**HELLO问候分组**（用于发现和维持邻站的可达性），并了解邻居节点的网络地址。
     2. 设置到它的每个邻居的成本度量$metric$。
     3. 构造**DD数据库描述分组**，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
     4. 如果**DD数据库描述分组**中的摘要自己都有，则邻站不做处理；如果有没有的或者是更新的，则发送**LSR链路状态请求分组**请求自己没有的和比自己更新的信息。
     5. 收到邻站的**LSR链路状态请求分组**后，发送**LSU链路状态更新分组**，使用洪泛法对全网链路进行更新。
     6. 更新完毕后，邻站返回一个**LSAck链路状态确认分组**进行确认。
     7. 根据$Dijkstra$算法与自己的链路状态数据库构造到其他结点之间的最短路径。
     8. 用**HELLO问候分组**分组保持与邻居的连接。

     当一个路由器的链路状态发生变化时，就会重复`5.`及其之后的步骤。

     通常隔$10$秒相邻两个路由器就要交换一次问候分组。且还要每隔一段时间如$30$分钟就要刷新依次数据库中的链路状态。

4.   $OSPF$协议的区域：为了使$OSPF$能够用于规模很大的网络，$OSPF$将一个自治系统再划分为若干个更小的范围，叫做**区域**。每一个区域都有一个$32$位的区域标识符（用点分十进制表示）。

     1.   一个区域内的路由器只知道本区域内的完整网络拓扑。
     2.   区域也不能太大，在一个区域内的路由器一般不超过$200$个。
     3.   路由器分为：

          + 主干路由器（可以兼任）。
          + 区域内部路由器。
          + 区域边界路由器。
          + 自治系统边界路由器。

5.   与$RIP$协议的区别

     1.   $OSPF$向本自治系统中的所有路由器发送信息，这里使用的方法是洪泛法而$RIP$仅向自己相邻的几个路由器发送信息。
     2.   $OSPF$发送的信息是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的**部分信息**。而在$RIP$中，发送的信息是本路由器所知道的**全部信息**，即整个路由表。

     3.   $OSPF$只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息，并且更新过程收敛得快，不会出现$RIP$路由环路即“坏消息传得慢”的问题。而在$RIP$中，不管网络拓扑是否发生变化，路由器之间都会定期交换路由表的信息。

     4.   ※※$OSPF$是网络层协议，它不使用$UDP$或$TCP$，而**直接用$IP$数据报传送**（其$IP$数据报首部的协议字段为$89$）。而$RIP$是应用层协议，它在传输层使用$UDP$。

     5.   $OSPF$中每个路由结点都使用同样的原始状态数据独立地计算路径，而不依赖中间结点的计算。而$RIP$依赖中间结点的计算。

6.   注意小点

     1.   $OSPF$对不同的链路可根据$IP$分组的不同服务类型$TOS$而设置成不同的代价。因此，$OSPF$对于不同类型的业务可计算出不同的路由，十分灵活。
     2.   如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这称为**多路径间的负载平衡**。
     3.   所有在$OSPF$路由器之间交换的分组都具有鉴别功能，因而保证了仅在可信赖的路由器之间交换链路状态信息。
     4.   支持可变长度的子网划分和无分类编址$CIDR$。
     5.   每个链路状态都带上一个$32$位的序号，序号越大，状态就越新。

7.   主要优点

     1.   每个路由结点都使用同样的原始状态数据独立地计算路径，而不依赖中间结点的计算
     2.   链路状态报文不加改变地传播，因此采用该算法易于查找故障。
     3.   当一个结点从所有其他结点接收到报文时，它可以在本地立即计算正确的通路，保证一步汇聚。
     4.   由于链路状态报文仅运载来自单个结点关于直接链路的信息，其大小与网络中的路由结点数目无关。因此**链路状态算法比距离-向量算法有更好的规模可伸展性。** 

#### 边界网关协议$BGP$

边界网关协议$BGP(Border\; Gateway\; Protocol)$是外部网关协议$EGP$，最新的版本是$BGP-4$。采用的是**路径向量路由选择协议**，与上面两种协议不同。

1.   BGP协议工作原理
     1.   每个自治系统的管理员至少选择一个路由器作为该自治系统的“$BGP$发言人”。
     2.   一个$BGP$发言人与其他自治系统中的$BGP$发言人要交换路由信息，就要先建立$TCP$连接

          +   可见**$BGP$报文是通过$TCP$传送**的，也就是说$BGP$报文是$TCP$报文的数据部分

     3.   然后在此连接上交换$BGP$报文以建立$BGP$会话$session$，利用$BGP$会话交换路由信息。

     4.   $BGP$发言人之间互相交换了网络可达性的信息后，各$BGP$发言人就根据所采用的策略从收到的路由信息中找出到达各$AS$的较好路由。

     5.   网络可达性信息是指到达某个网络所经过的路径（一整条），且这个路径不一定是最佳的，而是选择能到达且网络较好的。
2.   BGP协议特点
     1.   $BGP$是应用层协议，它是基于$TCP$的。
     2.   每个$BGP$发言人除必须运行$BGP$外，还必须运行该$AS$所用的内部网关协议，如$OSPF$或$RIP$。
     3.   $BGP$协议书寻找一条较好的路由，而非找一条最优路由。
     4.   每个自治系统中$BGP$发言人（或边界路由器）的数目很少，这样就使得自治系统之间的路由选择不致过分复杂。
     5.   $BGP$支持$CIDR$，因此$BGP$的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。
     6.   在$BGP$刚刚运行时，$BGP$的邻站是交换整个的$BGP$路由表，但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处。
3.   BGP-4报文类型
     1.   $OPEN$（打开）报文：用来与相邻的另一个$BGP$发言人建立关系，并认证发送方。
     2.   $UPDATE$（更新）报文：通告新路径或撤销原路径。
     3.   $KEEPALIVE$（保活）报文：在无$UPDATE$时，周期性证实邻站的连通性；也作为$OPEN$的确认。
     4.   $NOTIFICATION$（通知）报文：报告先前报文的差错；关闭连接。

#### 层次路由

1.   层次路由：当网络规模扩大时，路由器的路由表成比例地增大。这不仅会消耗越来越多的路由器缓冲区空间，而且需要用更多$CPU$时间来扫描路由表，用更多的带宽来交换路由状态信息。因此路由选择必须按照层次的方式进行。
2.   自治系统$AS$：在单一的技术管理下的一组路由器，而这些路由器使用一种$AS$内部的路由选择协议和共同的度量以确定分组在该$AS$内的路由，同时还使用一种$AS$之间的路由协议以确定在$AS$之间的路由。
     1.   自治系统$AS$就是多个使用同一种内部选择路由的协议的路由器之间构成的单独的小圈子，圈子内使用自己的协议，圈子和圈子之间也需要另一种$AS$协议。
     2.   一个$AS$内的所有网络都属于一个行政单位来管辖，一个自治系统的所有路由器在本自治系统内都必须连通。
3.   内部网关协议$IGP$和外部网关协议$EGP$：每个自治系统$AS$都有权自主地决定本系统内应采用何种路由选择协议，如果两个自治系统需要通信，那么就需要一种在两个自治系统之间的协议来屏蔽这些差异。据此，因特网把路由选择协议划分为两大类
     1.   内部网关协议$IGP$，即一个自治系统内部所使用的路由选择协议：$RIP$、$OSPF$
     2.   外部网关协议$EGP$，即自治系统之间所使用的路由选择协议，用于不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径：$BGP$
4.   层次路由和$OSPF$
     1.   使用层次路由时，$OSPF$将一个自治系统再划分为若干区域$Area$，每个路由器都知道在本区域内如何把分组路由到目的地的细节，但不用知道其他区域的内部结构。
     2.   采用分层次划分区域的方法虽然会使交换信息的种类增多，会使$OSPF$协议更加复杂。但这样做却能使每个区域内部交换路由信息的通信量大大减小，因而使$OSPF$协议能够用于规模很大的自治系统中。

### IP协议

#### ※※IP数据报

![image-20231023165512235](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202310231655319.png)

1.   版本（4位）：ipv4或者ipv6
2.   ※首部长度（4位）：**单位为4字节**，同时因为IP数据报固定长度（最小值）为20字节，所以此处最小值为5，即二进制的0101
3.   区分服务（8位）：希望获得哪种服务，用的比较少
4.   ※总长度（16位，2B）：首部和数据之和的长度，**单位为1字节**，最大为$2^{16}-1=65535B$，但是实际上永远不会达到该长度，因为有$MTU$的限制
5.   标识$Identification$（8位）：就是一个计数器，用来表示是哪一个数据报的分片，同一个数据报的分片标识相同
6.   ※标志$Flags$（3位，但实际有用的只有后两位）：用来表示是否分片和分片是否结束。
     1.   中间位DF（$Don't \;Fragment$）为1表示禁止分片，如果是0代表允许分片
     2.   最低位MF（$More \;Fragment$）为1表示后面还有分片，如果为0表示最后一片分片
7.   ※※片偏移（13位）：用来标记分片之后，该分片在原来的数据报的位置，**以8字节为单位**
8.   生存时间（8位）：即TTL，每经过一个路由器TTL-1，等于0时自动放弃，根据系统不同默认的TTL不同，为了防止无法传输的数据报在链路中无限传输
9.   协议（8位）：用来标记数据部分协议名的字段值，如ICMP：1；IGMP：2；**TCP：6**；EGP：8；IGP：9；**UDP：17**；IPv6：41；ESP：50；**OSPF：89**
10.   首部检验和（16位）：检验首部的字段是否出错，不包括数据部分，出错就丢弃此数据报
11.   ※源地址（32位）：发送方ip地址
12.   ※目的地址（32位）：接收方ip地址
13.   可选字段（可在0-40字节之间）：用于排错等安全检测
14.   ※填充：将数据报**对齐成4字节的整数倍**，数值全部为0

---

需要注意：

1.   由于$IP$具有标识，所以重传的数据不能与之前的数据进行重组。
2.   **数据部分永远在 4 字节的整数倍开始**，这样在实现 IP 协议时较为方便。
3.   由于片偏移为$8$的整数倍，所以分片后的数据报的数据部分长度必须在小于$(MTU-20B)$的前提下为$8$的整数倍。
4.   在IP数据报首部中有三个关于长度的标记，**首部长度、总长度、片偏移，基本单位分别为4B、1B、8B （需要记住）**。题目中经常会出现这几个长度之间的加减运算。

#### IP数据报分片

1.   由于为$IP$数据报被封装在链路层数据报中，故数据链路层的**最大传送单元$MTU$**严格地限制着$IP$数据报的长度
     + 以太网的$MTU$是$1500$字节。由于首部长$20B$，则数据部分长$1480B$。

     + 许多广域网的$MTU$不超过$576B$。
     + 在$IP$数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的$MTU$
2.   当$IP$分组超过$MTU$时为了传输就必须要分片，而如果$IP$分组不允许分片则无法传输，会返回上层一个差错报告。
3.   需要通过$IP$首部中的标志位$ Flags$后两位$DF$和$MF$同时确定。单独$MF=0$不能确定是独立的数据报，还是分片得来的，只有当$MF=0$且片段偏移字段$=0$时，才能确定是独立的$IP$数据包。
     + 当`DF = 0`时，该$IP$数据报才可以被分片
     + $MF$则用来告知目的主机该$IP$数据报是否为原始数据报的最后一个片
         + 当`MF = 1`时，表示相应的原始数据报还有后续的片
         + 当`MF = 0`时，表示该数据报是相应原始数据报的最后一个片

     + 目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始$IP$数据报的哪个位置

4.   **除了最后一个分片，其他所有片中的有效数据载荷都是8的倍数**

#### IP地址类别

1.   IP地址分类：均为哈夫曼前缀编码
     1.   A类IP地址：第一位为`0`。$1\sim 126$，全0是本主机地址，127.x.x.x是本地回环，目的地址为环回地址的IP数据报永远不会出现在任何网络上。每个单独的网络中最大主机数为$2^{24}-2$
     2.   B类IP地址：前两位为`10`。$128.1\sim 191.255$。每个单独的网络中最大主机数为$2^{16}-2$
     3.   C类IP地址：前三位为`110`。$192.0.1\sim 223.255.255$。每个单独的网络中最大主机数为$2^{8}-2$
     4.   D类IP地址：前四位为`1110`。224到239，多播地址。
     5.   E类IP地址：前四位为`1111`。240到255，无全1。保留地址。
2.   特殊$IP$地址

![image-20231023165357805](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202310231653948.png)

3.   IP地址特点
     1.   $IP$地址是标志一台主机（或路由器）和一条链路的接口，即当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的$IP$地址，每个$IP$地址的网络号必须与所在网络的网络号相同，且这两个$IP$地址的网络号是互相**不同**的
          + 因此$IP$网络上的一个路由器必然至少应具有两个$IP$地址（路由器每个端口必须至少分配一个$IP$地址），否则会冲突。
     2.   用转发器或桥接器（网桥等）连接的若干$LAN$仍然是同一个网络（同一个广播域），因此该$LAN$中所有主机的$IP$地址的网络号必须相同，但主机号必须不同。
     3.   在$IP$地址中，所有分配到网络号的网络（无论是$LAN$还是$WAN$）都是平等的。
     4.   路由器对目的地址是**私有$IP$地址**的数据报一律不进行转发。
     5.   在同一个局域网上的主机或路由器的$IP$地址中的网络号必须是一样的
          + 路由器总是具有两个或两个以上的$IP$地址，路由器的每个端口都有一个不同网络号的$IP$地址。

### 专用网络通信

#### 网络地址转换$NAT$

1.   网络地址转换$NAT$是指通过将专用网络地址（如内部网络$Intranet$）转换为公用地址（如因特网$Internet$），从而对外隐藏内部管理的$IP$地址。
     1.   它使得整个专用网只需要一个全球$IP$地址就可以与因特网连通，由于**专用网本地$IP$地址是可重用的**，所以$NAT$大大节省了$IP$地址的消耗。
     2.   同时，它隐藏了内部网络结构，从而降低了内部网络受到攻击的风险。
     3.   在进行$NAT$转发的时候必须保证内网地址与网络端口都一致，否则不转发。
     4.   此外，为了网络安全，划出了部分$IP$地址为私有$IP$地址，私有$IP$地址只用于局域网$LAN$，不用于广域网$WAN$连接
          +   因此私有$IP$地址不能直接用于因特网$Internet$，必须通过网关利用$NAT$把私有$IP$地址转换为因特网$Internet$中合法的全球$IP$地址后才能用于因特网$Internet$，并且允许私有$IP$地址被局域网$LAN$重复使用。
2.   私有$IP$地址（可重用$IP$地址）：不同于一般的全球$IP$地址，这些地址可以在机构内部自行分配使用，这张网络就是专用互联网或是本地互联网，当然也无法直接用于与因特网的通信。不同的两个局域网$LAN$中可能存在两个相同的$IP$地址
     1.   A 类：1 个 A 类网段，即 **10**.0.0.0〜**10**.255.255.255。
     2.   B 类：16 个 B 类网段，即 **172.16**.0.0〜**172.31**.255.255。
     3.   C 类：256 个 C 类网段，即 **192.168.0**.0〜**192.168.255**.255。 
3.   在**因特网$Internet$**中的所有路由器，对目的地址是私有地址的数据报一律不进行转发
     +   这种采用私有$IP$地址的互联网络称为专用互联网或本地互联网
     +   如果局域网$LAN$没有接入因特网，那么在局域网内部的路由器或交换机通常会对目的地址是私有地址的数据报进行转发
         +   因为在局域网$LAN$内部使用私有地址是合理的，并且这些私有地址在局域网范围内是有效的，可以用于内部通信。
4.   $NAT$路由器：只用在专用网与因特网的路由器上按照$NAT$软件，安装了$NAT$软件的路由器就是$NAT$路由器，其**至少有一个有效的外部全球$IP$地址**。
     1.   $NAT$路由器就是该本地专用网的代表，负责与外部因特网联通，分发外部的数据信息，发送时一定会按$NAT$转换表改变源$IP$地址或目的$IP$地址。
     2.   $NAT$路由器维护$NAT$转换表，包含$WAN$端与$LAN$端的散列值对。每个值都包含网络号与端口号。$NAT$路由器在发送和接收时都需要根据转换表更改$IP$地址。
          1.   从本网络接收到发送到其他网络的$IP$分组时，将$IP$分组的源$IP$地址和端口更改为$NAT$路由器自己的全球$IP$地址和路由器重新的端口
          2.   从其他网络接收到发送到本网络的$IP$分组时，将$IP$分组的目的$IP$地址和端口更改为本网络中对应主机的$IP$地址和端口
     3.   $NAT$路由器和普通路由器的区别
          1.   普通路由器工作在网络层；而$NAT$路由器工作在网络层和传输层，**转发数据报时需要查看和转换传输层的端口号**。
          2.   普通路由器在转发$IP$数据报时，不改变其源$IP$地址和目的$IP$地址；而$NAT$路由器在转发$IP$数据报时，一定要更换其$IP$地址（转换源$IP$地址或目的$IP$地址）
               + 硬件地址只具有本地意义，因此每当路由器将IP数据报转发到一个具体的网络中时，都需要重新封装源硬件地址和目的硬件地址

#### 虚拟专用网$VPN$

1.   虚拟专用网$VPN$（$Virtual\;Private\; Network$）：利用公用的互联网作为本地各专用网之间的通信载体。
2.   不同于互联网是因为它只用于本地网络的通信，但是又依靠互联网传输，所以就需要对数据进行加密。
3.   当$VPN$需要外部机构加入就是外联网$VPN$；如果成员分布分散，通过某种软件建立$VPN$通道，这种$VPN$就是远程接入$VPN$。

### 子网与超网

#### 子网划分

1.   子网划分由两级$IP$地址（网络号+主机号）变为三级$IP$地址（网络号+子网号+主机号），将原来的主机号分割出来一部分作为子网号
     + 子网的划分由单位内部完成，但是对外仍表现一个网络，外部无法看到本单位内子网的划分。
2.   子网划分的子网号可以全$0$或全$1$，网络地址和主网络的网络地址是重叠的。（与$CIDR$区别）
     +   由于子网可以全$0$和全$1$，所以**可用子网数量不用减二**。
3.   凡是从其他网络发送给本单位某台主机的$IP$数据报，仍然是根据$IP$数据报的目的网络号， 先找到连接到本单位网络上的路由器
     + 然后该路由器在收到$IP$数据报后，按目的网络号和子网号找到目的子网，最后把$IP$数据报直接交付给目的主机。
4.   划分子网只是把IP地址的主机号这部分进行再划分，而不改变IP地址原来的网络号
     + 因此，**从一个IP地址本身或IP数据报的首部，无法判断源主机或目的主机所连接的网络是否进行了子网划分**
5.   子网划分的影响：
     1.   划分子网可以增加子网的数量，子网之间的数据传输需要通过路由器进行，因此**减少了广播域的大小**
     2.   由于子网号占据了主机号位，所以会减少主机的数量
     3.   划分子网仅提高IP地址的利用率，并不增加网络的数量

#### 子网掩码

1.   将子网掩码与$IP$地址逐位进行与操作，就可以得到子网网络地址。在使用子网掩码的条件下，路由表不仅要给出目的网络地址和下一跳地址外，还需要给出目的网络的子网掩码。

     + $A$类地址的默认子网掩码是$255.0.0.0$。
     + $B$类地址的默认子网掩码是$255.255.0.0$。
     + $C$类地址的默认子网掩码是$255.255.255.0$。
2.   在使用子网掩码的情况下：

     1.   一台主机在设置IP地址信息的同时，必须设置子网掩码。
     2.   同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码。
     3.   路由器的路由表中，所包含信息的主要内容有目的网络地址、子网掩码、下一跳地址。

#### IP广播

如之前的保留地址所展示，如果需要进行广播，则包含两种广播方式。

1.   受限（有限）广播地址是$32$位全$1$的$IP$地址``255.255.255.255``，名义上是整个$IP$网络的网络广播地址，但是由于路由器对广播域的隔离作用，该地址实际表现为对本网络的广播。
     +   该地址用于主机配置过程中$IP$数据报的目的地址，主机不需要知道它所在网络的网络掩码，甚至不需要知道它的$IP$地址。
     +   在任何情况下，路由器都不转发目的地址为受限的广播地址的数据报，这样的数据报仅出现在本地网络中。
2.   直接广播地址包含一个有效的网络号和一个全$1$的主机号。根据$IP$地址与子网掩码将所有的主机号位全部置$1$，得到的地址就是该网络地址的直接广播地址。

#### 无分类编址CIDR

1.   CIDR地址块中的地址数一定是$2$的整数次幕，实际可指派的地址数通常为$2^ N-2$，其中$N$表示主机号的位数，主机号全0代表网络号，主机号全1为广播地址。
2.   $CIDR$记法：$IP$地址后加上/，然后写上网络前缀的位数。也可用使用：二进制网络前缀*。
3.   $CIDR$的优点在于网络前缀长度的灵活性。由于上层网络的前缀长度较短，因此相应的路由表的项目较少。而内部又可采用延长网络前缀的方法来灵活地划分子网。 
4.   $CIDR$查找路由表的方法：为了更加有效地查找最长前缀匹配，通常将无分类编址的路由表存放在一种层次式数据结构中，然后自上而下地按层次进行查找
     +   这里最常用的数据结构就是**二叉线索**
5.   最长前缀匹配（最佳匹配）：使用$CIDR$时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。
     +   此时，应当从匹配结果中选择**具有最长网络前缀的路由**，因为网络前缀越长，其地址块就越小，因而路由就越具体。

#### 构成超网

1.   有两个路由表项$206.1.0.0/17$和$206.1.128.0/17$，路由器会发现这两个表项到的网络地址都是同一个，所以可以合并为一个更大的地址块$206.1.0.0/16$。
2.   最长前缀匹配：使用$CIDR$时，查找路由表时可能得到多个匹配结果，应该选择具有最长网络前缀的路由，前缀越长，地址块越小，路由也越具体。

#### 网络层转发分组流程

路由表包括：

1. 目的网络地址。
2. 目的网络子网掩码。
3. 下一跳地址。

路由器转发分组的算法：

1. 从收到的$IP$分组的首部提取目的$IP$地址。
2. 若查找到特定主机路由（目的地址为$D $），就按照这条路由的下一跳转发分组；否则从转发表中的下一跳（即按前缀长度的顺序）开始检查，执行步骤`3.`
    +   查找到有特定主机路由（特殊地址，为了测试或安全），就直接按此路由传输。特殊路由如下
        1.   默认路由：如果是直连一个**互联网**，就直接是$0.0.0.0/0$，没有指定主机，需要特别记忆。
        2.   主机路由：对特定目的主机$IP$地址专门制定路由，指定子网掩码为$32$，表示子网掩码没有意义。
    +   得到下一跳路由器的IP地址后，并不是直接将该地址填入待发送的数据报，而是将该IP地址转换成MAC地址（通过ARP ）,将此MAC地址放到MAC帧首部中，然后根据这个MAC地址找到下一跳路由器。在不同网络中传送时，MAC帧中的源地址和目的地址要发生变化， 但是网桥在转发帧时，不改变帧的源地址，请注意区分。
3. 将这一行的子网掩码与目的地址进行按位与运算
    +   若运算结果与本行的前缀匹配，则查找结束，按照“下一跳”指出的进行处理
        1.   直接交付本网络上的目的主机
        2.   通过指定接口发送到下一跳路由器
    +   否则，若转发表还有下一行，则对下一行进行检查， 重新执行步骤`3.`
    +   其他情况，执行步骤`4.`
4. 若转发表中有一个默认路由`0.0.0.0`，则把分组传送给默认路由`0.0.0.0`，让其他路由器查看是否有该地址。否则，报告转发分组出错

### IP地址及其相关协议

#### IP地址与硬件地址

1.   IP地址是网络层使用的地址，它是分层次等级的
     1.   硬件地址是数据链路层使用的地址（MAC地址），它是平面式的
     2.   在网络层及网络层之上使用IP地址，IP地址放在IP数据报的首部，而MAC地址放在MAC帧的首部
     3.   通过数据封装，把IP数据报分组封装为MAC帧后，数据链路层看不见数据报分组中的IP地址
2.   由于路由器的隔离，IP网络中无法通过广播MAC地址来完成跨网络的寻址，因此在网络层只使用IP地址来完成寻址
     1.   在IP层抽象的互联网上只能看到IP数据报。
     2.   虽然在IP数据报首部中有源IP地址，但路由器只根据目的IP地址进行转发。
     3.   在局域网的链路层，只能看见MAC帧，故无论网络层使用什么协议，在实际网络的链路上传送数据帧时，最终必须使用硬件地址
          +   IP数据报被封装在MAC帧中
          +   通过路由器转发IP分组时，IP分组在每个网络中都被路由器解封装和重新封装，其MAC帧首部中的源地址和目的地址会不断改变，这也决定了无法使用MAC地址跨网络通信。
     4.   尽管互连在一起的网络的硬件地址体系各不相同，但IP层抽象的互联网却屏蔽了下层这些复杂的细节。只要我们在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机与主机或路由器之间的通信

#### 地址解析协议$ARP$

1.   地址解析协议$ARP$用于完成主机或路由器$IP$地址到$MAC$地址的映射
2.   每台主机都设有一个$ARP$高速缓存，用来存放本局域网上各主机和路由器的$IP$地址到$MAC$地址的映射表，称$ARP$表。使用$ARP$来动态维护此$ARP$表
3.   $ARP$由于“看到了” $IP$地址，所以它**工作在网络层**；而$NAT$路由器由于“看到了”端口，所以它工作在传输层
4.   $ARP$协议使用流程
     1.   检查在主机或路由器上的$ARP$高速缓存，如果有对应项就写入$MAC$帧。
     2.   ※广播发送：没有对应项，就用`FF-FF-FF-FF-FF-FF`作为目的$MAC$地址，并广播$ARP$请求分组，同一个局域网内的所有主机都能收到该请求。
     3.   单播发送：目的主机收到请求后会向源主机单播一个$ARP$响应分组，源主机收到后将该映射写入$ARP$缓存中。
     4.   如果源主机将源$MAC$地址与目的$MAC$地址与操作，发现目的主机不在同一个局域网，就查询本局域网的默认网关地址并填入目的$MAC$地址，传送到其他局域网。

#### 动态主机配置协议$DHCP$

1.   动态主机配置协议$DHCP$常用于给主机动态地分配IP地址，它提供了即插即用的联网机制，这种机制允许一台计算机加入新的网络和获取IP地址，而不用手工参与
2.   $DHCP$是**应用层协议**，它是**基于$UDP$**的。
3.   $DHCP$工作流程
     1.   主机广播“$DHCP$发现报文”，寻找网络中的$DHCP$服务器，从其中获得一个$IP$地址。
          +   源地址为`0.0.0.0`，目的地址为`255.255.255.255`
     2.   $DHCP$服务器收到“$DHCP$发现报文”后，广播“$DHCP$提供报文”，其中包括提供$DHCP$客户机的$IP$地址与配置信息。
          +   源地址为$DHCP$服务器地址，目的地址为`255.255.255.255`
     3.   $DHCP$客户机收到“$DHCP$提供报文”，接收$DHCP$服务器所提供的相关参数，客户机广播“$DHCP$请求报文”，向$DHCP$服务器请求提供$IP$地址。
          +   源地址为`0.0.0.0`，目的地址为`255.255.255.255`
     4.   $DHCP$服务器广播“$DHCP$确认报文”，将$IP$地址分配给$DHCP$客户机。
          +   源地址为$DHCP$服务器地址，目的地址为`255.255.255.255`
4.   $DHCP$注意事项
     1.   DHCP允许网络上配置多台DHCP服务器，则当DHCP客户机发出“DHCP发现”消息时，有可能收到多个应答消息
          +   这时，DHCP客户机只会挑选其中的一个，通常挑选最先到达的。
     2.   DHCP服务器分配给DHCP客户的IP地址是临时的，因此DHCP客户只能在一段有限的时间内使用这个分配到的IP地址
          +   DHCP称这段时间为**租用期**
          +   租用期的数值应由DHCP服务器自己决定，DHCP客户也可在自己发送的报文中提出对租用期的要求。
     3.   DHCP的客户端和服务器端需要通过广播方式来进行交互，因为在DHCP执行初期，客户端不知道服务器端的IP地址，而在执行中间，客户端并未被分配IP地址，从而导致两者之间的通信必须采用广播的方式
          +   采用UDP而不采用TCP的原因也很明显：TCP需要建立连接，如果连对方的IP地址都不知道，那么更不可能通过双方的套接字建立连接。
     4.   DHCP是应用层协议，因为它是通过客户/服务器模式工作的
          +   DHCP客户端向DHCP服务器请求服务，而其他层次的协议是没有这两种工作方式的

#### 网际控制报文协议$ICMP$

1.   $ICMP$协议是网络层的协议，$ICMP$报文是作为$IP$报文的一部分而传输的。

2.   ICMP差错报文

     1.   终点不可达：路由器或主机**不能交付数据报**时就向源点发送终点不可达报文
     2.   源点抑制：当路由器或主机由于**网络拥塞**而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢
     3.   改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(**可通过更好的路由**)
     4.   时间超过：当路由器**收到生存时间TTL=0的数据报**时，除丢弃该数据报外，还要向源点发送时间超过报文。
     5.   参数问题：当路由器或目的主机收到的数据报的首部中**有的字段的值不正确**时，就丢弃该数据报，并向源点发送参数问题报文

3.   不应发送$ICMP$差错报文的情况：

     1. 对$ICMP$差错报告报文（即使差错报文本身出错也不会管）。
     2. 对第一个分片的数据报片之后的所有后续数据报片。
     3. 对具有组播地址的数据报。
     4. 对具有特殊地址（如`127.0.0.1`或`0.0.0.0`）的数据报。

4.   ICMP询问报文

     1.   回送请求和回答报文
     2.   时间戳请求和回答报文
     3.   地址掩码请求和回答报文
     4.   路由器询问和通告报文

5.    ICMP应用

     1.   $PING$：测试两个主机之间的连通性，使用了$ICMP$回送请求和回答报文
          +   工作在应用层，直接使用网络层$ICMP$，而未使用$TCP$或$UDP$。
     2.   $Traceroute/Tracert$：跟踪一个分组从源点到终点，使用了$ICMP$时间超过差错报告报文
          +   工作在网络层。

### IPV6

![IPv6报头格式](https://trouvaille-oss.oss-cn-beijing.aliyuncs.com/picList/202307311058965.png)

1.   **IPv6帧格式**：
     1.   源地址和目标地址均为128位，16B
     2.   有效载荷长度（16位）：扩展首部+数据部分的大小，和ipv4的总长度和首部长度都不同，ipv6的首部长度是固定的40字节
     3.   下一个首部（报头）（8位）：基本首部的下一个首部指的是有效载荷里标记的的扩展首部，有效载荷里的扩展首部再指向有效载荷里标记的的扩展首部，直至最后指向数据
2.   IPv6与IPv4的区别
     1.   **将校验和字段彻底移除**，减少每跳处理时间。
     2.   支持即插即用（即自动配置），不需要$DHCP$协议。
     3.   首部是$8$字节的整数倍，而$IPv4$首部是$4$字节的整数倍。
     4.   $IPv6$只能在主机处即包的源结点分片，而$IPv4$能在主机和路由器处分片，所以$IPv6$不允许分片。
     5.   将可选字段移出首部，首部长度固定，变成**扩展首部**（丢弃了首部长度字段），更加灵活。
3.   IPv4和IPv6之间的过渡
     1.   双栈协议：在一台设备上同时启用$IPv4$协议栈和$IPv6$协议栈
          1.   设备为路由器，那么路由器的不同接口上，分别配置了$IPv4$地址和$IPv6$地址，并很可能分别连接了$IPv4$网络和$IPv6$网络
          2.   设备为主机，那么它将同时拥有$IPv4$地址和$IPv6$地址，并具备同时处理这两个协议地址的功能。
     2.   隧道技术：通过使用互联网络的基础设施在网络之间传递数据的方式；使用隧道传递的数据（或负载）可以是不同协议的数据帧或包；隧道协议将其它协议的数据帧或包重新封装然后通过隧道发送。

### IP多播（组播）

1.   组播实现
     1.   只在本局域网上进行硬件组播：主机组播时仅发送一份数据，只有数据在传送路径出现分岔时才将分组复制后继续转发
     2.   在因特网的范围内进行组播：靠路由器来实现；在因特网上进行组播的最后阶段，还是要把组播数据报在局域网上用硬件组播交付给组播组的所有成员
2.   IP组播地址：$IP$组播使用$D$类地址格式，范围是`244.0.0.0`到`239.255.255.255`，一个$D$类地址表示一个组播组，只能用作目的地址，源地址必然是单播地址。
3.   注意小点
     1.   组播仅使用$UDP$，不提供可靠交付
     2.   组播地址（$D$类地址）只能用于目的地址，而不能用于源地址。
     4.   对组播数据报不产生$ICMP$差错报文，因此，若在`PING`命令后面键入组播地址，将永远不会收到响应

### 移动IP

1.   移动IP的概念：移动结点（计算机/服务器等）以固定的网络$IP$地址，实现跨越不同网段的漫游功能，并保证了基于网络$IP$的网络权限在漫游过程中不发生任何改变。
2.   功能实体：移动节点、本地代理（也称归属代理）和外地代理：
     1.   移动节点：具有永久$IP$地址的移动站。
     2.   归属代理/本地代理：一个移动结点拥有的永久“居所”称为归属网络，在归属网络中代表移动节点执行，移动管理功能的实体叫做归属代理，通常就是连接在归属网络（原始连接到的网络）上的路由器。
     3.   外部代理/外地代理：在外部网络中帮助移动节点完成移动管理功能的实体称为外部代理，通常就是连接在被访网络（移动到另一地点所接入的网络）上的路由器。
3.   相应地址：
     1.   永久地址（归属地址/主地址）：移动站点在**归属网络**中的原始地址。永久地址和归属网络的关联是不变的。
     2.   转交地址（辅地址）：移动站点在外部网络使用的临时地址。
          + 归属代理通常是连接到归属网络上的路由器，然而它实现的代理功能是在**应用层**完成的
     3.   被访网络：当移动站移动到另一地点，所接入的外地网络
     4.   外地代理：被访网络中使用的代理，通常是连接在被访网络上的路由器。外地代理有两个重要功能：
          1.   要为移动站创建一个临时地址，称为转交地址。转交地址的网络号显然和被访网络一致
          2.   及时把移动站的转交地址告诉其归属代理。 
4.   通信过程
     1.   移动站$A$在归属网络时：按传统的$TCP/IP$方式进行通信
     2.   $A$刚进入外部网络：

          1. 在外部代理登记获得一个临时的转交地址，离开时注销。（外部代理广播报文）
          2. 移动节点通过外部代理发送注册报文给归属代理。（包含永久地址&转交地址）
          3. 归属代理接收请求，并将移动节点的永久地址和转交地址绑定，并返回一注册响应报文。
              +   以后到达该归属代理的数据报且要发往移动节点的数据报将被封装并以隧道方式发给转交地址
          4. 外部代理接收注册响应，并转发给移动节点。
     3.   $B$给$A$发送数据报：

          1. 本地代理截获数据报。
          2. 本地代理再封装数据报，新的数据报目的地址是转交地址，发给外部代理（隧道）。
          3. 外部代理拆封数据报并发给$A$。
     4.   $A$给$B$发送数据报：

          1.   $A$用自己的主地址作为数据报源地址，用$B$的$IP$地址作为数据报的目的地址。
     5.   $A$移动到了下一个网络：

          1. 在新外部代理登记注册一个转交地址。
          2. 新外部代理给本地代理发送新的转交地址（覆盖旧的）。
          3. 通信。
     6.   $A$回到了归属网络:

          1. $A$向本地代理注销转交地址。
          2. 按原始方式通信。

### 网络层设备（路由器）

网络层设备（路由器）可以划分广播域和冲突域。

1.   路由器的组成和功能
     1.   功能主要为分组转发和路由计算，不进行差错检测。
     2.   可以通过用路由器将网络分段控制网络上的广播风暴。
     3.   当源主机要向目标主机发送数据报时，路由器先检查源主机与目标主机是否连接在同一个网络上。同一个网络中传递数据无须路由器的参与，而跨网络通信必须通过路由器进行转发。

          +   如果源主机和目标主机在同一个网络上，那么直接交付而无须通过路由器。
          +   如果源主机和目标主机不在同一个网络上，那么路由器按照转发表（路由表）指出的路由将数据报转发给下一个路由器，这称为**间接交付**。
     4.   路由器由路由选择和分组转发两部分构成
          1.   **路由选择部分**也称**控制部分**，其核心构件是**路由选择处理机**。路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断更新和维护路由表。 
          2.   **分组转发部分**由三部分组成：交换结构、一组输入端口、一组输出端口。
               +   输入端口在从物理层接收到的比特流中提取出数据链路层帧，进而从帧中提取出网络层数据报，输出端口则执行恰好相反的操作

               +   交换结构是路由器的关键部件，它根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。交换结构本身就是一个网络。 其中有三种常用的交换方法：

                   1.   通过存储器进行交换
                   2.   通过总线进行交换
                   3.   通过互联网络进行交换
     5.   路由器主要完成两个功能：一是分组转发，二是路由计算
          1.   前者处理通过路由器的数据流， 关键操作是转发表查询、转发及相关的队列管理和任务调度等
          2.   后者通过和其他路由器进行基于路由协议的交互，完成路由表的计算。
     6.   路由器和网桥的重要区别是：网桥与高层协议无关；而路由器是面向协议的
          1.   它依据网络地址进行操作，并进行路径选择、分段、帧格式转换、对数据报的生存时间和流量进行控制等
          2.   现今的路由器一般都提供多种协议的支持，包括$OSI、TCP/IP、IPX$等。
2.   路由表与路由转发：路由表由路由选择算法得到，主要用于路由选择，总由软件实现
     1.   路由表项包括四个部分：目的网络$IP$地址、子网掩码、下一跳$IP$地址、接口。
     2.   每个路由表都有一个默认路由：$0.0.0.0/0$，当不知道发送给谁或互联网时就发送这个默认路由，让别的路由器帮忙处理。
     3.   **※一般默认网关地址就是路由器的$LAN$端口地址。**